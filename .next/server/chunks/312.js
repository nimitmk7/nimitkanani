"use strict";exports.id=312,exports.ids=[312],exports.modules={13781:(e,r,o)=>{o.d(r,{X:()=>i});var t=o(55732);function i(e){let r=e.getType("_Service");if(!(0,t.lp)(r))return!1;let o=r.getFields().sdl;if(!o)return!1;let i=o.type;return(0,t.zM)(i)&&(i=i.ofType),!!(0,t.KA)(i)&&"String"==i.name}},44312:(e,r,o)=>{o.d(r,{ApolloServerPluginSchemaReporting:()=>u});var t=o(22037),i=o(69480),a=o(56573),s=o(35264),n=o(88309),p=o(78553),l=o(91967),h=o(27663);let c=`#graphql
  mutation SchemaReport($report: SchemaReport!, $coreSchema: String) {
    reportSchema(report: $report, coreSchema: $coreSchema) {
      __typename
      ... on ReportSchemaError {
        message
        code
      }
      ... on ReportSchemaResponse {
        inSeconds
        withCoreSchema
      }
    }
  }
`;class m{constructor(e){this.headers={"Content-Type":"application/json","x-api-key":e.apiKey,"apollographql-client-name":"ApolloServerPluginSchemaReporting","apollographql-client-version":h.b},this.endpointUrl=e.endpointUrl||"https://schema-reporting.api.apollographql.com/api/graphql",this.schemaReport=e.schemaReport,this.coreSchema=e.coreSchema,this.isStopped=!1,this.logger=e.logger,this.initialReportingDelayInMs=e.initialReportingDelayInMs,this.fallbackReportingDelayInMs=e.fallbackReportingDelayInMs,this.fetcher=e.fetcher??l.default}stopped(){return this.isStopped}start(){this.pollTimer=setTimeout(()=>this.sendOneReportAndScheduleNext(!1),this.initialReportingDelayInMs)}stop(){this.isStopped=!0,this.pollTimer&&(clearTimeout(this.pollTimer),this.pollTimer=void 0)}async sendOneReportAndScheduleNext(e){if(this.pollTimer=void 0,!this.stopped())try{let r=await this.reportSchema(e);if(!r)return;this.stopped()||(this.pollTimer=setTimeout(()=>this.sendOneReportAndScheduleNext(r.withCoreSchema),1e3*r.inSeconds));return}catch(e){this.logger.error(`Error reporting server info to Apollo during schema reporting: ${e}`),this.stopped()||(this.pollTimer=setTimeout(()=>this.sendOneReportAndScheduleNext(!1),this.fallbackReportingDelayInMs))}}async reportSchema(e){let{data:r,errors:o}=await this.apolloQuery({report:this.schemaReport,coreSchema:e?this.coreSchema:null});if(o)throw Error(o.map(e=>e.message).join("\n"));function t(e){return["Unexpected response shape from Apollo when","reporting schema. If this continues, please reach","out to support@apollographql.com.","Received response:",JSON.stringify(e)].join(" ")}if(!r||!r.reportSchema)throw Error(t(r));if("ReportSchemaResponse"===r.reportSchema.__typename)return r.reportSchema;if("ReportSchemaError"===r.reportSchema.__typename)return this.logger.error(["Received input validation error from Apollo:",r.reportSchema.message,"Stopping reporting. Please fix the input errors."].join(" ")),this.stop(),null;throw Error(t(r))}async apolloQuery(e){let r=await this.fetcher(this.endpointUrl,{method:"POST",headers:this.headers,body:JSON.stringify({query:c,variables:e})});if(!r.ok)throw Error(`An unexpected HTTP status code (${r.status}) was encountered during schema reporting.`);try{return await r.json()}catch(e){throw Error(["Couldn't report schema to Apollo.","Parsing response as JSON failed.","If this continues please reach out to support@apollographql.com",e].join(" "))}}}var d=o(13781),g=o(24202);function u({initialDelayMaxMs:e,overrideReportedSchema:r,endpointUrl:o,fetcher:l}=Object.create(null)){let c=(0,a.Z)();return(0,i.U)({__internal_plugin_id__:"SchemaReporting",__is_disabled_plugin__:!1,async serverWillStart({apollo:i,schema:a,logger:u}){let S;let{key:f,graphRef:y}=i;if(!f)throw Error("To use ApolloServerPluginSchemaReporting, you must provide an Apollo API key, via the APOLLO_KEY environment variable or via `new ApolloServer({apollo: {key})`");if(!y)throw Error("To use ApolloServerPluginSchemaReporting, you must provide your graph ref (eg, 'my-graph-id@my-graph-variant'). Try setting the APOLLO_GRAPH_REF environment variable or passing `new ApolloServer({apollo: {graphRef}})`.");if(r)try{let e=(0,s.F)((0,n.I)(r,{noLocation:!0}));if(e.length)throw Error(e.map(e=>e.message).join("\n"))}catch(e){throw Error(`The schema provided to overrideReportedSchema failed to parse or validate: ${e.message}`)}if((0,d.X)(a))throw Error("Schema reporting is not yet compatible with Apollo Federation subgraphs. If you're interested in using schema reporting with subgraphs, please contact Apollo support. To set up managed federation, see https://go.apollo.dev/s/managed-federation");void 0!==o&&u.info(`Apollo schema reporting: schema reporting URL override: ${o}`);let R={bootId:c,graphRef:y,platform:process.env.APOLLO_SERVER_PLATFORM||"local",runtimeVersion:`node ${process.version}`,userVersion:process.env.APOLLO_SERVER_USER_VERSION,serverId:process.env.APOLLO_SERVER_ID||process.env.HOSTNAME||t.hostname(),libraryVersion:`@apollo/server@${h.b}`};return{schemaDidLoadOrUpdate({apiSchema:t,coreSupergraphSdl:i}){if(void 0!==r){if(S)return;u.info("Apollo schema reporting: schema to report has been overridden")}let a=r??i??(0,p.t3)(t),s=(0,g.n)(a),n={...R,coreSchemaHash:s};S?.stop(),(S=new m({schemaReport:n,coreSchema:a,apiKey:f,endpointUrl:o,logger:u,initialReportingDelayInMs:Math.floor(Math.random()*(e??1e4)),fallbackReportingDelayInMs:2e4,fetcher:l})).start(),u.info(`Apollo schema reporting: reporting a new schema to Studio! See your graph at https://studio.apollographql.com/graph/${encodeURI(y)}/ with server info ${JSON.stringify(n)}`)},async serverWillStop(){S?.stop()}}}})}}};