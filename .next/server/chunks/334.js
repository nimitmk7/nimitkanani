"use strict";exports.id=334,exports.ids=[334],exports.modules={60334:(e,t,r)=>{r.d(t,{ApolloServerPluginUsageReporting:()=>k});var s=r(23666),n=r(54550),a=r(42579),o=r(78553),i=r(46180),l=r(91967),u=r(22037),c=r(59796),h=r(69480),p=r(21731),d=r(20708);function y(e,t,r){let s=r?new m:g;if(e.root&&f(e.root,s,t)||e.queryPlan&&function e(t,r,s){return!!t&&(t.fetch?.trace?.root&&t.fetch.serviceName?f(t.fetch.trace.root,r.child(`service:${t.fetch.serviceName}`),s):t.flatten?.node?e(t.flatten.node,r,s):t.parallel?.nodes?t.parallel.nodes.some(t=>e(t,r,s)):!!t.sequence?.nodes&&t.sequence.nodes.some(t=>e(t,r,s)))}(e.queryPlan,s,t))return}function f(e,t,r){return!!r(e,t)||(e.child?.some(e=>{let s=e.responseName?t.child(e.responseName):t;return f(e,s,r)})??!1)}let g={toArray(){throw Error("not collecting paths!")},child(){return this}};class m{toArray(){return[]}child(e){return new b(e,this)}}class b{constructor(e,t){this.responseName=e,this.prev=t}toArray(){let e=[],t=this;for(;t instanceof b;)e.push(t.responseName),t=t.prev;return e.reverse()}child(e){return new b(e,this)}}class C{toArray(){let e=0,t=[];for(let r of this.buckets)0===r?e++:(1===e?t.push(0):0!==e&&t.push(-e),t.push(Math.floor(r)),e=0);return t}static durationToBucket(e){let t=Math.ceil(Math.log(e/1e3)/C.EXPONENT_LOG);return t<=0||Number.isNaN(t)?0:t>=C.BUCKET_COUNT?C.BUCKET_COUNT-1:t}incrementDuration(e,t=1){return this.incrementBucket(C.durationToBucket(e),t),this}incrementBucket(e,t=1){if(e>=C.BUCKET_COUNT)throw Error("Bucket is out of bounds of the buckets array");if(e>=this.buckets.length){let t=this.buckets.length;this.buckets.length=e+1,this.buckets.fill(0,t)}this.buckets[e]+=t}combine(e){for(let t=0;t<e.buckets.length;t++)this.incrementBucket(t,e.buckets[t])}constructor(e){let t=e?.initSize||74,r=e?.buckets,s=Math.max(r?.length||0,t);this.buckets=Array(s).fill(0),r&&r.forEach((e,t)=>this.buckets[t]=e)}}C.BUCKET_COUNT=384,C.EXPONENT_LOG=Math.log(1.1);class T{constructor(){this.bytes=0}}class S{constructor(e){this.header=e,this.tracesPreAggregated=!1,this.tracesPerQuery=Object.create(null),this.endTime=null,this.operationCount=0,this.sizeEstimator=new T}ensureCountsAreIntegers(){for(let e of Object.values(this.tracesPerQuery))e.ensureCountsAreIntegers()}addTrace({statsReportKey:e,trace:t,asTrace:r,referencedFieldsByType:n,maxTraceBytes:a=10485760,nonFtv1ErrorPaths:o}){let i=this.getTracesAndStats({statsReportKey:e,referencedFieldsByType:n});if(r){let e=s.fM.encode(t).finish();!isNaN(a)&&e.length>a?i.statsWithContext.addTrace(t,this.sizeEstimator,o):(i.trace.push(e),this.sizeEstimator.bytes+=2+e.length)}else i.statsWithContext.addTrace(t,this.sizeEstimator,o)}getTracesAndStats({statsReportKey:e,referencedFieldsByType:t}){let r=this.tracesPerQuery[e];if(r)return r;for(let[r,s]of(this.sizeEstimator.bytes+=q(e),Object.entries(t)))for(let e of(this.sizeEstimator.bytes+=4,s.isInterface&&(this.sizeEstimator.bytes+=2),this.sizeEstimator.bytes+=q(r),s.fieldNames))this.sizeEstimator.bytes+=q(e);return this.tracesPerQuery[e]=new v(t)}}class v{constructor(e){this.referencedFieldsByType=e,this.trace=[],this.statsWithContext=new w,this.internalTracesContributingToStats=[]}ensureCountsAreIntegers(){this.statsWithContext.ensureCountsAreIntegers()}}class w{constructor(){this.map=Object.create(null)}toArray(){return Object.values(this.map)}ensureCountsAreIntegers(){for(let e of Object.values(this.map))e.ensureCountsAreIntegers()}addTrace(e,t,r){this.getContextualizedStats(e,t).addTrace(e,t,r)}getContextualizedStats(e,t){let r={clientName:e.clientName,clientVersion:e.clientVersion},s=JSON.stringify(r),n=this.map[s];if(n)return n;t.bytes+=20+q(e.clientName)+q(e.clientVersion);let a=new E(r);return this.map[s]=a,a}}class E{constructor(e){this.context=e,this.queryLatencyStats=new N,this.perTypeStat=Object.create(null)}ensureCountsAreIntegers(){for(let e of Object.values(this.perTypeStat))e.ensureCountsAreIntegers()}addTrace(e,t,r=[]){let{fieldExecutionWeight:n}=e;if(!n&&this.queryLatencyStats.requestsWithoutFieldInstrumentation++,this.queryLatencyStats.requestCount++,e.fullQueryCacheHit?(this.queryLatencyStats.cacheLatencyCount.incrementDuration(e.durationNs),this.queryLatencyStats.cacheHits++):this.queryLatencyStats.latencyCount.incrementDuration(e.durationNs),!e.fullQueryCacheHit&&e.cachePolicy?.maxAgeNs!=null)switch(e.cachePolicy.scope){case s.fM.CachePolicy.Scope.PRIVATE:this.queryLatencyStats.privateCacheTtlCount.incrementDuration(e.cachePolicy.maxAgeNs);break;case s.fM.CachePolicy.Scope.PUBLIC:this.queryLatencyStats.publicCacheTtlCount.incrementDuration(e.cachePolicy.maxAgeNs)}e.persistedQueryHit&&this.queryLatencyStats.persistedQueryHits++,e.persistedQueryRegister&&this.queryLatencyStats.persistedQueryMisses++,e.forbiddenOperation&&this.queryLatencyStats.forbiddenOperationCount++,e.registeredOperation&&this.queryLatencyStats.registeredOperationCount++;let a=!1,o=new Set;for(let{subgraph:s,path:i}of(y(e,(e,r)=>{if(e.error?.length){a=!0;let s=this.queryLatencyStats.rootErrorStats;r.toArray().forEach(e=>{s=s.getChild(e,t)}),o.add(s),s.errorsCount+=e.error.length}if(n){let r=e.originalFieldName||e.responseName;if(e.parentType&&r&&e.type&&null!=e.endTime&&null!=e.startTime&&e.endTime>=e.startTime){let s=this.getTypeStat(e.parentType,t).getFieldStat(r,e.type,t);s.errorsCount+=e.error?.length??0,s.observedExecutionCount++,s.estimatedExecutionCount+=n,s.requestsWithErrorsCount+=(e.error?.length??0)>0?1:0,s.latencyCount.incrementDuration(e.endTime-e.startTime,n)}}return!1},!0),r))if(a=!0,i){let e=this.queryLatencyStats.rootErrorStats.getChild(`service:${s}`,t);i.forEach(r=>{"string"==typeof r&&(e=e.getChild(r,t))}),o.add(e),e.errorsCount+=1}for(let e of o)e.requestsWithErrorsCount+=1;a&&this.queryLatencyStats.requestsWithErrorsCount++}getTypeStat(e,t){let r=this.perTypeStat[e];if(r)return r;t.bytes+=q(e);let s=new A;return this.perTypeStat[e]=s,s}}class N{constructor(){this.latencyCount=new C,this.requestCount=0,this.requestsWithoutFieldInstrumentation=0,this.cacheHits=0,this.persistedQueryHits=0,this.persistedQueryMisses=0,this.cacheLatencyCount=new C,this.rootErrorStats=new P,this.requestsWithErrorsCount=0,this.publicCacheTtlCount=new C,this.privateCacheTtlCount=new C,this.registeredOperationCount=0,this.forbiddenOperationCount=0}}class P{constructor(){this.children=Object.create(null),this.errorsCount=0,this.requestsWithErrorsCount=0}getChild(e,t){let r=this.children[e];if(r)return r;let s=new P;return this.children[e]=s,t.bytes+=q(e)+4,s}}class A{constructor(){this.perFieldStat=Object.create(null)}getFieldStat(e,t,r){let s=this.perFieldStat[e];if(s)return s;r.bytes+=q(e)+q(t)+10;let n=new O(t);return this.perFieldStat[e]=n,n}ensureCountsAreIntegers(){for(let e of Object.values(this.perFieldStat))e.ensureCountsAreIntegers()}}class O{constructor(e){this.returnType=e,this.errorsCount=0,this.observedExecutionCount=0,this.estimatedExecutionCount=0,this.requestsWithErrorsCount=0,this.latencyCount=new C}ensureCountsAreIntegers(){this.estimatedExecutionCount=Math.floor(this.estimatedExecutionCount)}}function q(e){return 2+Buffer.byteLength(e)}var x=r(27663),I=r(24202),R=r(13781);let L={hostname:u.hostname(),agentVersion:`@apollo/server@${x.b}`,runtimeVersion:`node ${process.version}`,uname:`${u.platform()}, ${u.type()}, ${u.release()}, ${u.arch()})`};function k(e=Object.create(null)){let t=e.fieldLevelInstrumentation,r="number"==typeof t?async()=>Math.random()<t?1/t:0:t||(async()=>!0),u=null;return(0,h.U)({__internal_plugin_id__:"UsageReporting",__is_disabled_plugin__:!1,requestDidStart:async e=>u?u(e):{},async serverWillStart({logger:t,apollo:h,startedInBackground:f,schema:g}){let m,b;let T=e.logger??t,{key:v,graphRef:w}=h;if(!(v&&w))throw Error("You've enabled usage reporting via ApolloServerPluginUsageReporting, but you also need to provide your Apollo API key and graph ref, via the APOLLO_KEY/APOLLO_GRAPH_REF environment variables or via `new ApolloServer({apollo: {key, graphRef})`.");if((0,R.X)(g)){if(e.__onlyIfSchemaIsNotSubgraph)return T.warn("You have specified an Apollo API key and graph ref but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph; usage reporting is disabled. To enable usage reporting anyway, explicitly install `ApolloServerPluginUsageReporting`. To disable this warning, install `ApolloServerPluginUsageReportingDisabled`."),{};T.warn("You have installed `ApolloServerPluginUsageReporting` but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph. If this was unintentional, remove `ApolloServerPluginUsageReporting` from your server's `plugins` array.")}T.info(`Apollo usage reporting starting! See your graph at https://studio.apollographql.com/graph/${encodeURI(w)}/`);let E=e.sendReportsImmediately??f,N=null,P=new Map,A=e=>{let t=P.get(e);if(t)return t;let r=new S(new s.UD({...L,executableSchemaId:e,graphRef:w}));return P.set(e,r),r},O=e=>{let t=P.get(e);return t?(P.delete(e),t):null},q=e.overrideReportedSchema?(0,I.n)(e.overrideReportedSchema):void 0;E||(b=setInterval(()=>_(),e.reportIntervalMs||1e4));let x=e.sendTraces??!0,k=e.experimental_sendOperationAsTrace??function(){let e=new d.Z({maxSize:1048576,sizeCalculation:(e,t)=>t&&Buffer.byteLength(t)||0});return(t,r)=>{let s;let n=t.endTime?.seconds;if(null==n)throw Error("programming error: endTime not set on trace");let a=(s=!1,y(t,function(e){return(e.error?.length??0)>0&&(s=!0),s},!1),s),o=JSON.stringify([r,C.durationToBucket(t.durationNs),Math.floor(n/60),a?Math.floor(n/5):""]);return!e.get(o)&&(e.set(o,!0),!0)}}(),U=!1;function M(e){if(m?.executableSchema===e)return m.executableSchemaId;let t=(0,I.n)((0,o.t3)(e));return m={executableSchema:e,executableSchemaId:t},t}async function _(){await Promise.all([...P.keys()].map(e=>F(e)))}async function F(t){return $(t).catch(t=>{e.reportErrorFunction?e.reportErrorFunction(t):T.error(t.message)})}let $=async t=>{let r=O(t);if(!r||0===Object.keys(r.tracesPerQuery).length&&0===r.operationCount)return;r.endTime=(0,p.F)(new Date),r.ensureCountsAreIntegers();let n=s.yG.verify(r);if(n)throw Error(`Error verifying report: ${n}`);let o=s.yG.encode(r).finish();if(r=null,e.debugPrintReports){let e=s.yG.decode(o);T.info(`Apollo usage report: ${JSON.stringify(e.toJSON())}`)}let u=await new Promise((e,t)=>{(0,c.gzip)(o,(r,s)=>{r?t(r):e(s)})});o=null;let h=e.fetcher??l.default,d=await a(async()=>{let t;let r=new i.AbortController,s=setTimeout(()=>{r.abort()},e.requestTimeoutMs??3e4);try{t=await h((e.endpointUrl||"https://usage-reporting.api.apollographql.com")+"/api/ingress/traces",{method:"POST",headers:{"user-agent":"ApolloServerPluginUsageReporting","x-api-key":v,"content-encoding":"gzip",accept:"application/json"},body:u,signal:r.signal})}finally{clearTimeout(s)}if(!(t.status>=500)||!(t.status<600))return t;throw Error(`HTTP status ${t.status}, ${await t.text()||"(no body)"}`)},{retries:(e.maxAttempts||5)-1,minTimeout:e.minimumRetryDelayMs||100,factor:2}).catch(e=>{throw Error(`Error sending report to Apollo servers: ${e.message}`)});if(d.status<200||d.status>=300)throw Error(`Error sending report to Apollo servers: HTTP status ${d.status}, ${await d.text()||"(no body)"}`);if(x&&200===d.status&&d.headers.get("content-type")?.match(/^\s*application\/json\s*(?:;|$)/i)){let e;let t=await d.text();try{e=JSON.parse(t)}catch(e){throw Error(`Error parsing response from Apollo servers: ${e}`)}!0===e.tracesIgnored&&(T.debug("This graph's organization does not have access to traces; sending all subsequent operations as stats."),x=!1)}e.debugPrintReports&&T.info(`Apollo usage report: status ${d.status}`)};return u=({metrics:t,schema:a,request:{http:o,variables:i}})=>{let l=new p.X({maskedBy:"ApolloServerPluginUsageReporting",sendErrors:e.sendErrors});l.startTiming(),t.startHrTime=l.startHrTime;let u=!1,c=!1,h=null;async function y(t){if(null===h){if("function"!=typeof e.includeRequest){h=!0;return}"boolean"!=typeof(h=await e.includeRequest(t))&&(T.warn("The 'includeRequest' async predicate function must return a boolean value."),h=!0)}}o&&(l.trace.http=new s.fM.HTTP({method:s.fM.HTTP.Method[o.method]||s.fM.HTTP.Method.UNKNOWN}),e.sendHeaders&&function(e,t,r){if(r&&(!("none"in r)||!r.none)&&(!("all"in r)||r.all)){for(let[n,a]of t)if(!("exceptNames"in r&&r.exceptNames.some(e=>e.toLowerCase()===n))&&(!("onlyNames"in r)||r.onlyNames.some(e=>e.toLowerCase()===n)))switch(n){case"authorization":case"cookie":case"set-cookie":break;default:e.requestHeaders[n]=new s.fM.HTTP.Values({value:[a]})}}}(l.trace.http,o.headers,e.sendHeaders));let f=!1;return{async didResolveSource(r){f=!0,t.persistedQueryHit&&(l.trace.persistedQueryHit=!0),t.persistedQueryRegister&&(l.trace.persistedQueryRegister=!0),i&&(l.trace.details=function(e,t,r){let n=new s.fM.Details,a=(()=>{if(!t||!("transform"in t))return e;{let s=Object.keys(e);try{let n=t.transform({variables:e,operationString:r});return function(e,t){let r=Object.create(null);return e.forEach(e=>{r[e]=t[e]}),r}(s,n)}catch(e){return function(e){let t=Object.create(null);return e.forEach(e=>{t[e]="[PREDICATE_FUNCTION_ERROR]"}),t}(s)}}})();return Object.keys(a).forEach(e=>{if(!t||"none"in t&&t.none||"all"in t&&!t.all||"exceptNames"in t&&t.exceptNames.includes(e)||"onlyNames"in t&&!t.onlyNames.includes(e))n.variablesJson[e]="";else try{n.variablesJson[e]=void 0===a[e]?"":JSON.stringify(a[e])}catch(t){n.variablesJson[e]=JSON.stringify("[Unable to convert value to JSON]")}}),n}(i,e.sendVariableValues,r.source));let n=(e.generateClientInfo||function({request:e}){let t="apollographql-client-name",r="apollographql-client-version";return e.http?.headers?.get(t)||e.http?.headers?.get(r)?{clientName:e.http?.headers?.get(t),clientVersion:e.http?.headers?.get(r)}:e.extensions?.clientInfo?e.extensions.clientInfo:{}})(r);if(n){let{clientName:e,clientVersion:t}=n;l.trace.clientVersion=t||"",l.trace.clientName=e||""}},validationDidStart:async()=>async e=>{u=!!e&&0!==e.length},async didResolveOperation(e){if(c=void 0===e.operation,await y(e),h&&!c&&void 0===t.captureTraces){let s=await r(e);l.trace.fieldExecutionWeight="number"==typeof s?s:s?1:0,t.captureTraces=!!l.trace.fieldExecutionWeight}},async executionDidStart(){if(t.captureTraces)return{willResolveField:({info:e})=>l.willResolveField(e)}},async didEncounterSubsequentErrors(e,t){l.didEncounterErrors(t)},async willSendSubsequentPayload(e,t){t.hasNext||await g(e)},async willSendResponse(e){f&&(e.errors&&l.didEncounterErrors(e.errors),"single"===e.response.body.kind&&await g(e))}};async function g(r){let o=!!r.operation;await y(r),l.stopTiming();let i=q??M(a);if(!1===h){o&&A(i).operationCount++;return}l.trace.fullQueryCacheHit=!!t.responseCacheHit,l.trace.forbiddenOperation=!!t.forbiddenOperation,l.trace.registeredOperation=!!t.registeredOperation;let p=r.overallCachePolicy.policyIfCacheable();async function f(){let i,h;if(U)return;await new Promise(e=>setImmediate(e));let p=q??M(a),{trace:y}=l;r.document?u?h=`## GraphQLValidationFailure
`:c&&(h=`## GraphQLUnknownOperationName
`):h=`## GraphQLParseFailure
`;let f=void 0===h;if(h)e.sendUnexecutableOperationDocuments&&(y.unexecutedOperationBody=r.source,y.unexecutedOperationName=r.request.operationName||""),i=Object.create(null);else{let t=function(){var t,s;if(!r.document)throw Error("No document?");let o=(t=r.queryHash,s=r.operationName||"",`${t}${s&&":"+s}`);N&&N.forSchema===a||(N={forSchema:a,cache:function({logger:e}){let t;let r=0;return new d.Z({sizeCalculation:e=>Buffer.byteLength(JSON.stringify(e),"utf8"),maxSize:10485760,dispose(){r++,(!t||new Date().getTime()-t.getTime()>6e4)&&(t=new Date,e.warn(`This server is processing a high number of unique operations.  A total of ${r} records have been ejected from the ApolloServerPluginUsageReporting signature cache in the past interval.  If you see this warning frequently, please open an issue on the Apollo Server repository.`),r=0)}})}({logger:T})});let i=N.cache.get(o);if(i)return i;let l={signature:(e.calculateSignature||n.usageReportingSignature)(r.document,r.operationName||""),referencedFieldsByType:(0,n.calculateReferencedFieldsByType)({document:r.document,schema:a,resolvedOperationName:r.operationName??null})};return N.cache.set(o,l),l}();h=`# ${r.operationName||"-"}
${t.signature}`,i=t.referencedFieldsByType}let g=s.fM.verify(y);if(g)throw Error(`Error encoding trace: ${g}`);o&&A(p).operationCount++,A(p).addTrace({statsReportKey:h,trace:y,asTrace:x&&(!f||!!t.captureTraces)&&!t.nonFtv1ErrorPaths?.length&&k(y,h),referencedFieldsByType:i,nonFtv1ErrorPaths:t.nonFtv1ErrorPaths??[]}),(E||A(p).sizeEstimator.bytes>=(e.maxUncompressedReportSize||4194304))&&await F(p)}p&&(l.trace.cachePolicy=new s.fM.CachePolicy({scope:"PRIVATE"===p.scope?s.fM.CachePolicy.Scope.PRIVATE:"PUBLIC"===p.scope?s.fM.CachePolicy.Scope.PUBLIC:s.fM.CachePolicy.Scope.UNKNOWN,maxAgeNs:1e9*p.maxAge})),t.queryPlanTrace&&(l.trace.queryPlan=t.queryPlanTrace),f().catch(T.error)}},{async serverWillStop(){b&&(clearInterval(b),b=void 0),U=!0,await _()}}}})}}};