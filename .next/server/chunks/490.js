"use strict";exports.id=490,exports.ids=[490],exports.modules={51490:(e,t,a)=>{a.d(t,{ApolloServerPluginCacheControl:()=>o});var n=a(55732),r=a(31290),l=a(91682),i=a(69480),c=a(20708);function o(e=Object.create(null)){let t,a;return(0,i.U)({__internal_plugin_id__:"CacheControl",__is_disabled_plugin__:!1,async serverWillStart({schema:e}){t=new c.Z({max:Object.values(e.getTypeMap()).filter(n.Gv).length}),a=new c.Z({max:Object.values(e.getTypeMap()).filter(n.lp).flatMap(e=>Object.values(e.getFields())).length+Object.values(e.getTypeMap()).filter(n.oT).flatMap(e=>Object.values(e.getFields())).length})},async requestDidStart(i){function c(e){let a=t.get(e);if(a)return a;let n=function(e){if(e.astNode){let t=d(e.astNode.directives);if(t)return t}if(e.extensionASTNodes)for(let t of e.extensionASTNodes){let e=d(t.directives);if(e)return e}return{}}(e);return t.set(e,n),n}let o=e.defaultMaxAge??0,h=e.calculateHttpHeaders??!0,{__testing__cacheHints:f}=e;return{async executionDidStart(){if(p(i.overallCachePolicy)){let e=(0,l.b)();return{willResolveField({info:t}){t.cacheControl={setCacheHint:t=>{e.replace(t)},cacheHint:e,cacheHintFromType:c}}}}return{willResolveField({info:e}){let t=(0,l.b)(),s=!1,u=(0,n.xC)(e.returnType);if((0,n.Gv)(u)){let e=c(u);t.replace(e),s=!!e.inheritMaxAge}let h=function(e){let t=a.get(e);if(t)return t;let n=function(e){if(e.astNode){let t=d(e.astNode.directives);if(t)return t}return{}}(e);return a.set(e,n),n}(e.parentType.getFields()[e.fieldName]);return h.inheritMaxAge&&void 0===t.maxAge?(s=!0,h.scope&&t.replace({scope:h.scope})):t.replace(h),e.cacheControl={setCacheHint:e=>{t.replace(e)},cacheHint:t,cacheHintFromType:c},()=>{if(void 0===t.maxAge&&((0,n.Gv)(u)&&!s||!e.path.prev)&&t.restrict({maxAge:o}),f&&p(t)){let a=(0,r.N)(e.path).join(".");if(f.has(a))throw Error("shouldn't happen: addHint should only be called once per path");f.set(a,{maxAge:t.maxAge,scope:t.scope})}i.overallCachePolicy.restrict(t)}}}},async willSendResponse(e){if(!h)return;let{response:t,overallCachePolicy:a}=e,n=function(e){if(!e)return{kind:"no-header"};if(e===u)return{kind:"uncacheable"};let t=s.exec(e);return t?{kind:"parsable-and-cacheable",hint:{maxAge:+t[1],scope:"public"===t[2]?"PUBLIC":"PRIVATE"}}:{kind:"unparsable"}}(t.http.headers.get("cache-control"));if("unparsable"===n.kind)return;let r=(0,l.b)();r.replace(a),"parsable-and-cacheable"===n.kind&&r.restrict(n.hint);let i=r.policyIfCacheable();i&&"uncacheable"!==n.kind&&"single"===t.body.kind&&!t.body.singleResult.errors?t.http.headers.set("cache-control",`max-age=${i.maxAge}, ${i.scope.toLowerCase()}`):"if-cacheable"!==h&&t.http.headers.set("cache-control",u)}}}})}let s=/^max-age=(\d+), (public|private)$/,u="no-store";function d(e){if(!e)return;let t=e.find(e=>"cacheControl"===e.name.value);if(!t||!t.arguments)return;let a=t.arguments.find(e=>"maxAge"===e.name.value),n=t.arguments.find(e=>"scope"===e.name.value),r=t.arguments.find(e=>"inheritMaxAge"===e.name.value),l=n?.value?.kind==="EnumValue"?n.value.value:void 0,i="PUBLIC"===l||"PRIVATE"===l?l:void 0;return r?.value?.kind==="BooleanValue"&&r.value.value?{inheritMaxAge:!0,scope:i}:{maxAge:a?.value?.kind==="IntValue"?parseInt(a.value.value):void 0,scope:i}}function p(e){return void 0!==e.maxAge||void 0!==e.scope}}};